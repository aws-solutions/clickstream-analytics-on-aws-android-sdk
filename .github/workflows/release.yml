name: Release Next Version
on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release Tag'
        required: true
        type: string
env:
  NEW_VERSION: ${{ github.event.inputs.release_tag }}
jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.PROJECT_TOKEN }}
      - name: Modify for next release
        run: |
          chmod +x release.sh
          ./release.sh ${{ env.NEW_VERSION }}
          git diff
          git config user.name '${{ vars.USER_NAME }}'
          git config user.email '${{ vars.USER_EMAIL }}'
          git add .
          git commit -m 'release: clickstream Android ${{ env.NEW_VERSION }}'
          git push
          git tag v${{ env.NEW_VERSION }}
          git push origin v${{ env.NEW_VERSION }}
      - name: Assemble release
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease
      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          name: "Clickstream Android ${{ env.NEW_VERSION }}"
          files: |
            clickstream/build/outputs/aar/clickstream-release.aar
          tag_name: "v${{ env.NEW_VERSION }}"
          prerelease: true
          generate_release_notes: true